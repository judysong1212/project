<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Ye16Ta1100">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="ye16Ta1100SrhVo" type="com.app.exterms.yearendtax.server.vo.InfcPsnl0100SrhVO"/>
	
	<select id="ye16Ta1100DAO.selectPsnl0100List_D" parameterClass="ye16Ta1100SrhVo" resultClass="egovMap">
		SELECT * FROM (
			SELECT T.*, ROWNUM RNUM FROM (
					SELECT AA.DPOB_CD
					        , AA.SYSTEMKEY
					        , BB.EMYMT_DIV_CD
					        , fcBass0300CDNM (AA.DPOB_CD, BB.EMYMT_DIV_CD) AS EMYMT_DIV_NM
					        , AA.HAN_NM
					        , AA.RESN_REGN_NUM
					        , AA.NATN_CD
					        , fcBass0300CDNM (AA.DPOB_CD, AA.NATN_CD) AS NATN_NM
					        , BB.DEPT_CD
					        , fcBass0400CDNM (AA.DPOB_CD, BB.DEPT_CD, '2') AS DEPT_NM
					        , BB.TYP_OCCU_CD
					        , fcBass0320CDNM(AA.DPOB_CD, BB.TYP_OCCU_CD)AS TYP_OCCU_NM 
					        , BB.DTIL_OCCU_INTTN_CD
					        ,  (CASE WHEN BB.EMYMT_DIV_CD = 'A0020010'
					            THEN fcBassEx0350CDNM(AA.DPOB_CD, BB.TYP_OCCU_CD, BB.DTIL_OCCU_INTTN_CD, '1')
					           ELSE (SELECT B.BUSIN_NM 
					                        FROM BASS0500 B
					                        WHERE B.DPOB_CD = BB.DPOB_CD 
					                            AND B.DEPT_CD = BB.DEPT_CD 
					                            AND B.BUSIN_CD = BB.BUSIN_CD
					                            AND B.BUSIN_APPTN_YR =SUBSTR(BB.EMYMT_BGNN_DT,1,4)
					                  )         
					           END)AS DTIL_OCCU_INTTN_NM
					         , AA.FRST_EMYMT_DT
					         , BB.EMYMT_BGNN_DT
					         , BB.EMYMT_END_DT
					         , BB.BUSIN_CD
					         , AA.HDOFC_CODTN_CD
					         , fcBass0300CDNM (AA.DPOB_CD, AA.HDOFC_CODTN_CD) AS HDOFC_CODTN_NM
					         , CC.PAYR_MANG_DEPT_CD
					FROM PSNL0100 AA, PAYR0500 CC,
					(SELECT CC01.DPOB_CD
							, CC01.SYSTEMKEY
							, CC01.EMYMT_DIV_CD
					        , CC01.DEPT_CD
					        , CC01.TYP_OCCU_CD
					        , CC01.DTIL_OCCU_INTTN_CD
					        , CC01.BUSIN_CD
					        , MIN (CC01.EMYMT_BGNN_DT) AS EMYMT_BGNN_DT
					        , MAX (NVL (CC01.EMYMT_END_DT, TO_CHAR (SYSDATE, 'YYYYMMDD')))AS EMYMT_END_DT
					  FROM PSNL0110 CC01
					 WHERE     CC01.DPOB_CD = #dpobCd#
							<isNotEmpty prepend="AND" property="emymtDivCd" >
					 			CC01.EMYMT_DIV_CD=#emymtDivCd#
							</isNotEmpty>
							<isEqual prepend="AND" property="emymtDivCd" compareValue="A0020010">
								CC01.DTIL_OCCU_INTTN_CD IS NOT NULL
							</isEqual>
					       AND CC01.EMYMT_TYP_CD NOT IN ('A0420990')
					       AND CC01.EMYMT_BGNN_DT = ( SELECT MAX(CC02.EMYMT_BGNN_DT)
                                                                FROM PSNL0110 CC02
                                                              WHERE CC02.DPOB_CD = CC01.DPOB_CD 
                                                                AND CC02.SYSTEMKEY = CC01.SYSTEMKEY 
                                                                AND CC02.EMYMT_DIV_CD = CC01.EMYMT_DIV_CD
                                                                AND ( TO_CHAR(#emymtBgnnDt#) <![CDATA[ >= ]]> CC01.EMYMT_BGNN_DT    
															            AND TO_CHAR(#emymtBgnnDt#) <![CDATA[ <=  ]]>  NVL (CC01.EMYMT_END_DT,  (CASE WHEN TO_CHAR(#emymtBgnnDt#) <![CDATA[ <= ]]> TO_CHAR ( SYSDATE,'YYYYMMDD')
																					                                                              THEN TO_CHAR(SYSDATE,'YYYYMMDD')
																					                                                            ELSE TO_CHAR(#emymtBgnnDt# )      
																					                                                            END) 
																					                                       )     
															            OR  TO_CHAR(#emymtEndDt#) <![CDATA[  >= ]]>  CC01.EMYMT_BGNN_DT
															            AND TO_CHAR(#emymtEndDt#) <![CDATA[ <= ]]>   NVL (CC01.EMYMT_END_DT, (CASE WHEN TO_CHAR(#emymtEndDt#) <![CDATA[ >= ]]>  TO_CHAR (SYSDATE,'YYYYMMDD')
																					                                                              THEN TO_CHAR (SYSDATE,'YYYYMMDD')
																					                                                             ELSE  TO_CHAR(#emymtEndDt#)
																					                                                             END)
																					                                         )
																	)				                                         
					                               	 	)
					
					GROUP BY CC01.DPOB_CD
					         , CC01.SYSTEMKEY
					         , CC01.EMYMT_DIV_CD
					         , CC01.DEPT_CD
					         , CC01.TYP_OCCU_CD
					         , CC01.DTIL_OCCU_INTTN_CD
					         , CC01.BUSIN_CD) BB 
					WHERE AA.DPOB_CD = BB.DPOB_CD
					    AND AA.SYSTEMKEY = BB.SYSTEMKEY 
					    AND AA.DPOB_CD = CC.DPOB_CD 
					    AND AA.SYSTEMKEY = CC.SYSTEMKEY  
						<isNotEmpty prepend="AND" property="dpobCd" >
							AA.DPOB_CD=#dpobCd#
				    	</isNotEmpty> 
				    		<isNotEmpty property="deptCd" prepend="AND">
								<![CDATA[
							      DECODE(AA.CURR_AFFN_DEPT_CD,BB.DEPT_CD,BB.DEPT_CD,BB.DEPT_CD) 
								]]>
								<iterate prepend="IN" property="deptCdArr" open="(" close=")" conjunction=",">
								 #deptCdArr[]#
								</iterate>
								</isNotEmpty> 
				     AND NOT EXISTS ( SELECT TA01.DPOB_CD , TA01.YRTX_BLGG_YR , TA01.CLUT_SEPT_CD , TA01.SYSTEMKEY
				     				  FROM YE161010 TA01, YE161020 TA02
				     				  WHERE TA01.DPOB_CD = TA02.DPOB_CD
				     				  	AND TA01.YRTX_BLGG_YR = TA02.YRTX_BLGG_YR
				     				  	AND TA01.CLUT_SEPT_CD = TA02.CLUT_SEPT_CD
				     				  	AND TA01.SYSTEMKEY = TA02.SYSTEMKEY
				     				  	AND TA01.DPOB_CD = #dpobCd#
				     				  	AND TA01.YRTX_BLGG_YR = #clutYr#
				     				  	AND TA01.CLUT_SEPT_CD = #clutSeptCd#
				     				  	AND TA01.SYSTEMKEY = AA.SYSTEMKEY
				     		         )
				     AND EXISTS  (
                         SELECT  C.DPOB_CD,
                                 C.DTIL_OCCU_INTTN_CD,
                                 C.TYP_OCCU_CD,
                                 C.DEPT_CD FROM 
                                             (SELECT * 
                                                 FROM TABLE(PKG_DTIL_AUTH.FN_DTIL_AUTH_TB(#dpobCd#,#payrMangDeptYn#,#payrMangDeptCd#,#deptCd#,#usrId#,#deptCdAuth#,#edacRvyy# )) ) C
                                            WHERE     C.DPOB_CD = AA.DPOB_CD
						                        AND C.DEPT_CD = AA.CURR_AFFN_DEPT_CD
						                        AND NVL(C.TYP_OCCU_CD,'TT')  = NVL(AA.TYP_OCCU_CD,'TT') 
                                                AND NVL(C.DTIL_OCCU_INTTN_CD,'TT')  = NVL(AA.DTIL_OCCU_INTTN_CD,'TT')
                                             
                                          )
                    <isNotEmpty prepend="AND" property="businCd" >
					 	AA.BUSIN_CD=#businCd#
				    </isNotEmpty> 
					<isNotEmpty prepend="AND" property="payrMangDeptCd" >
					 	CC.PAYR_MANG_DEPT_CD=#payrMangDeptCd#
				    </isNotEmpty> 
				    <isNotEmpty prepend="AND" property="emymtDivCd" >
					 	BB.EMYMT_DIV_CD=#emymtDivCd#
					</isNotEmpty>
					<isNotEmpty property="hdofcCodtnCd" prepend="AND">
						<![CDATA[
							 AA.HDOFC_CODTN_CD
						]]>
						<iterate prepend="IN" property="hdofcCodtnCdArr" open="(" close=")" conjunction=",">
							 #hdofcCodtnCdArr[]#
						</iterate>
					</isNotEmpty>  
				    <isNotEmpty property="typOccuCd" prepend="AND">
						<![CDATA[
							 BB.TYP_OCCU_CD
						]]>
						<iterate prepend="IN" property="typOccuCdArr" open="(" close=")" conjunction=",">
						 	 #typOccuCdArr[]#
						</iterate>
					</isNotEmpty>  
					<!-- 
					<isNotEmpty property="pyspGrdeCd" prepend="AND">
						<![CDATA[
							 NVL(A.PYSP_GRDE_CD,'A0060000')
						]]>
						<iterate prepend="IN" property="pyspGrdeCdArr" open="(" close=")" conjunction=",">
							 #pyspGrdeCdArr[]#
						</iterate>
					</isNotEmpty>  
					 -->
					<isNotEmpty property="dtilOccuInttnCd" prepend="AND">
						<![CDATA[
							 BB.DTIL_OCCU_INTTN_CD
						]]>
						<iterate prepend="IN" property="dtilOccuInttnCdArr" open="(" close=")" conjunction=",">
							 #dtilOccuInttnCdArr[]#
						</iterate>
					</isNotEmpty>  
				    <isNotEmpty prepend="AND" property="systemkey" >
					 	AA.SYSTEMKEY=#systemkey#
				    </isNotEmpty>  
				    <isNotEmpty prepend="AND" property="hanNm" >
					 	AA.HAN_NM LIKE '%' || #hanNm# || '%'
				    </isNotEmpty> 					
					ORDER BY 
					    AA.DPOB_CD DESC
					    , ( SELECT LPAD(DEPT_RANK,5,'0')  
					            FROM BASS0400 DD
					        WHERE DD.DEPT_CD = BB.DEPT_CD
					            AND DD.DPOB_CD = BB.DPOB_CD) ASC
					    , AA.RESN_REGN_NUM ASC
					    , AA.SYSTEMKEY DESC
                          
		
	<isNotEqual  property="lastIndex" compareValue="-1">
 	<![CDATA[					
				) T WHERE ROWNUM <= #lastIndex#
		)WHERE RNUM >= #firstIndex#
	]]>
	</isNotEqual>	
	<isEqual   property="lastIndex" compareValue="-1">
  	<![CDATA[					
		) T  
	)
	]]>
	</isEqual>	
	</select>	
	
	<select id="ye16Ta1100DAO.selectPsnl0100ListCnt_S" parameterClass="ye16Ta1100SrhVo" resultClass="int">
			SELECT COUNT(*) totcnt
			FROM ( SELECT AA.DPOB_CD
					        , AA.SYSTEMKEY
					FROM PSNL0100 AA, PAYR0500 CC,
					( SELECT CC01.DPOB_CD
							, CC01.SYSTEMKEY
							, CC01.EMYMT_DIV_CD
					        , CC01.DEPT_CD
					        , CC01.TYP_OCCU_CD
					        , CC01.DTIL_OCCU_INTTN_CD
					        , CC01.BUSIN_CD
					        , MIN (CC01.EMYMT_BGNN_DT) AS EMYMT_BGNN_DT
					        , MAX (NVL (CC01.EMYMT_END_DT, TO_CHAR (SYSDATE, 'YYYYMMDD')))AS EMYMT_END_DT
					  FROM PSNL0110 CC01
					 WHERE     CC01.DPOB_CD = #dpobCd#
							<isNotEmpty prepend="AND" property="emymtDivCd" >
					 			CC01.EMYMT_DIV_CD=#emymtDivCd#
							</isNotEmpty>
							
							<isEqual prepend="AND" property="emymtDivCd" compareValue="A0020010">
								CC01.DTIL_OCCU_INTTN_CD IS NOT NULL
							</isEqual>
							AND CC01.EMYMT_TYP_CD NOT IN ('A0420990')
					      	AND CC01.EMYMT_BGNN_DT = ( SELECT MAX(CC02.EMYMT_BGNN_DT)
                                                                FROM PSNL0110 CC02
                                                              WHERE CC02.DPOB_CD = CC01.DPOB_CD 
                                                                AND CC02.SYSTEMKEY = CC01.SYSTEMKEY 
                                                                AND CC02.EMYMT_DIV_CD = CC01.EMYMT_DIV_CD 
                                                                AND ( TO_CHAR(#emymtBgnnDt#) <![CDATA[ >= ]]> CC01.EMYMT_BGNN_DT    
															            AND TO_CHAR(#emymtBgnnDt#) <![CDATA[ <=  ]]>  NVL (CC01.EMYMT_END_DT,  (CASE WHEN TO_CHAR(#emymtBgnnDt#) <![CDATA[ <= ]]> TO_CHAR ( SYSDATE,'YYYYMMDD')
																					                                                              THEN TO_CHAR(SYSDATE,'YYYYMMDD')
																					                                                            ELSE TO_CHAR(#emymtBgnnDt# )      
																					                                                            END) 
															                                       							)     
															            OR  TO_CHAR(#emymtEndDt#) <![CDATA[  >= ]]>  CC01.EMYMT_BGNN_DT
															            AND TO_CHAR(#emymtEndDt#) <![CDATA[ <= ]]>   NVL (CC01.EMYMT_END_DT, (CASE WHEN TO_CHAR(#emymtEndDt#) <![CDATA[ >= ]]>  TO_CHAR (SYSDATE,'YYYYMMDD')
																				                                                               THEN TO_CHAR (SYSDATE,'YYYYMMDD')
																				                                                              ELSE  TO_CHAR(#emymtEndDt#)
															                                                             					  END)
															               	                           						)
															 		)                            						
					                                 	)			      
					GROUP BY CC01.DPOB_CD
					         , CC01.SYSTEMKEY
					         , CC01.EMYMT_DIV_CD
					         , CC01.DEPT_CD
					         , CC01.TYP_OCCU_CD
					         , CC01.DTIL_OCCU_INTTN_CD
					         , CC01.BUSIN_CD) BB
					WHERE AA.DPOB_CD = BB.DPOB_CD
					    AND AA.SYSTEMKEY = BB.SYSTEMKEY 
					    AND AA.DPOB_CD = CC.DPOB_CD 
					    AND AA.SYSTEMKEY = CC.SYSTEMKEY  
						<isNotEmpty prepend="AND" property="dpobCd" >
							AA.DPOB_CD=#dpobCd#
				    	</isNotEmpty>
				    		<isNotEmpty property="deptCd" prepend="AND">
								<![CDATA[
							      DECODE(AA.CURR_AFFN_DEPT_CD,BB.DEPT_CD,BB.DEPT_CD,BB.DEPT_CD) 
								]]>
								<iterate prepend="IN" property="deptCdArr" open="(" close=")" conjunction=",">
								 #deptCdArr[]#
								</iterate>
								</isNotEmpty>  
				     AND NOT EXISTS ( SELECT TA01.DPOB_CD , TA01.YRTX_BLGG_YR , TA01.CLUT_SEPT_CD , TA01.SYSTEMKEY
				     				  FROM YE161010 TA01, YE161020 TA02
				     				  WHERE TA01.DPOB_CD = TA02.DPOB_CD
				     				  	AND TA01.YRTX_BLGG_YR = TA02.YRTX_BLGG_YR
				     				  	AND TA01.CLUT_SEPT_CD = TA02.CLUT_SEPT_CD
				     				  	AND TA01.SYSTEMKEY = TA02.SYSTEMKEY
				     				  	AND TA01.DPOB_CD = #dpobCd#
				     				  	AND TA01.YRTX_BLGG_YR = #clutYr#
				     				  	AND TA01.CLUT_SEPT_CD = #clutSeptCd#
				     				  	AND TA01.SYSTEMKEY = AA.SYSTEMKEY
				     		         )				    	
				     AND EXISTS  (
                         SELECT  C.DPOB_CD,
                                 C.DTIL_OCCU_INTTN_CD,
                                 C.TYP_OCCU_CD,
                                 C.DEPT_CD FROM 
                                             (SELECT * 
                                                 FROM TABLE(PKG_DTIL_AUTH.FN_DTIL_AUTH_TB(#dpobCd#,#payrMangDeptYn#,#payrMangDeptCd#,#deptCd#,#usrId#,#deptCdAuth#,#edacRvyy# ))) C
                                            WHERE     C.DPOB_CD = AA.DPOB_CD
						                        AND C.DEPT_CD = AA.CURR_AFFN_DEPT_CD
						                        AND NVL(C.TYP_OCCU_CD,'TT')  = NVL(AA.TYP_OCCU_CD,'TT') 
                                                AND NVL(C.DTIL_OCCU_INTTN_CD,'TT')  = NVL(AA.DTIL_OCCU_INTTN_CD,'TT')
                                          
                                          )
                    <isNotEmpty prepend="AND" property="businCd" >
					 	AA.BUSIN_CD=#businCd#
				    </isNotEmpty> 
					<isNotEmpty prepend="AND" property="payrMangDeptCd" >
					 	CC.PAYR_MANG_DEPT_CD=#payrMangDeptCd#
				    </isNotEmpty> 
				    <isNotEmpty prepend="AND" property="emymtDivCd" >
					 	BB.EMYMT_DIV_CD=#emymtDivCd#
					</isNotEmpty>
					<isNotEmpty property="hdofcCodtnCd" prepend="AND">
						<![CDATA[
							 AA.HDOFC_CODTN_CD
						]]>
						<iterate prepend="IN" property="hdofcCodtnCdArr" open="(" close=")" conjunction=",">
							 #hdofcCodtnCdArr[]#
						</iterate>
					</isNotEmpty>  
				    <isNotEmpty property="typOccuCd" prepend="AND">
						<![CDATA[
							 BB.TYP_OCCU_CD
						]]>
						<iterate prepend="IN" property="typOccuCdArr" open="(" close=")" conjunction=",">
						 	 #typOccuCdArr[]#
						</iterate>
					</isNotEmpty>  
					<!-- 
					<isNotEmpty property="pyspGrdeCd" prepend="AND">
						<![CDATA[
							 NVL(A.PYSP_GRDE_CD,'A0060000')
						]]>
						<iterate prepend="IN" property="pyspGrdeCdArr" open="(" close=")" conjunction=",">
							 #pyspGrdeCdArr[]#
						</iterate>
					</isNotEmpty>  
					 -->
					<isNotEmpty property="dtilOccuInttnCd" prepend="AND">
						<![CDATA[
							 BB.DTIL_OCCU_INTTN_CD
						]]>
						<iterate prepend="IN" property="dtilOccuInttnCdArr" open="(" close=")" conjunction=",">
							 #dtilOccuInttnCdArr[]#
						</iterate>
					</isNotEmpty>  
				    <isNotEmpty prepend="AND" property="systemkey" >
					 	AA.SYSTEMKEY=#systemkey#
				    </isNotEmpty>  
				    <isNotEmpty prepend="AND" property="hanNm" >
					 	AA.HAN_NM LIKE '%' || #hanNm# || '%'
				    </isNotEmpty> 					
					ORDER BY 
					    AA.DPOB_CD DESC
					    , ( SELECT LPAD(DEPT_RANK,5,'0')  
					            FROM BASS0400 DD
					        WHERE DD.DEPT_CD = BB.DEPT_CD
					            AND DD.DPOB_CD = BB.DPOB_CD) ASC
					    , AA.RESN_REGN_NUM ASC
					    , AA.SYSTEMKEY DESC
	)
	</select>
	
	
	
</sqlMap>
