<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SysmHist0200">

	<typeAlias alias="hashMap" type="java.util.HashMap"/>
    <typeAlias alias="list" type="java.util.List"/>
    <typeAlias alias="int" type="java.lang.Integer"/>
    <typeAlias alias="string" type="java.lang.String"/>
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="sysmHist0200SrhVo" type="com.app.smrmf.sysm.server.vo.SysIfHist0200SrhVO"/>
	<typeAlias  alias="sysmHist0200Vo" type="com.app.smrmf.sysm.server.vo.SysIfHist0200VO"/>
	
		<resultMap id="sysm3200" class="com.app.smrmf.sysm.server.vo.SysIfHist0200SrhVO">
		<result property="tablespacenm" column="TABLESPACE_NAME" columnIndex="1"/>
		<result property="filenm" column="FILE_NAME" columnIndex="2"/>
		<result property="bytesb" column="BYTESB" columnIndex="3"/>
		<result property="free" column="FREE" columnIndex="4"/>
		<result property="bytes" column="BYTES" columnIndex="5"/>
		<result property="percentage" column="PERCENTAGE" columnIndex="6"/>
		<result property="fileid" column="FILE_ID" columnIndex="7"/>
		</resultMap>
	
	<select id="sysmHist0200DAO.getHour" resultClass="egovMap">
	    SELECT LPAD((0), 2, 0)AS COMM_CD
	    FROM DUAL
	    UNION ALL
	    SELECT LPAD((LEVEL), 2, 0)AS COMM_CD
	    FROM DUAL   
		CONNECT BY LEVEL <![CDATA[ <=  ]]> 23
	</select>
	
	<select id="sysmHist0200DAO.getMinute" resultClass="egovMap">
	    SELECT LPAD((0), 2, 0)AS COMM_CD
	    FROM DUAL
	    UNION ALL
	    SELECT LPAD((LEVEL), 2, 0)AS COMM_CD
	    FROM DUAL   
		CONNECT BY LEVEL <![CDATA[ <=  ]]>59
	</select>
	 
	
	<select id="sysmHist0200DAO.selectHist0200ListTotCnt_S" parameterClass="sysmHist0200SrhVo" resultClass="int">
			SELECT COUNT(*) totcnt
			FROM HIST0200
			WHERE 1=1
			<isNotNull property="dpobCd">
			     <isNotEmpty property="dpobCd" prepend="AND">
					DPOB_CD = #dpobCd#
			     </isNotEmpty>
			 </isNotNull>
			 
			<isNotNull property="usrConnectDivCd">
				<isNotEmpty property="usrConnectDivCd" prepend="AND">
					USR_CONNECT_DIV_CD = #usrConnectDivCd#
				</isNotEmpty>
			</isNotNull>
				 
			 <isNotNull property="systemkey">
			     <isNotEmpty property="systemkey" prepend="AND">
			        USR_ID = (SELECT  USR_ID FROM SYSM0200 WHERE DPOB_CD = #dpobCd# AND SYSTEMKEY= #systemkey#)
			     </isNotEmpty>
			 </isNotNull>
			 
			 <isNotNull property="usrJobBgnnTm">
			     <isNotEmpty property="usrJobBgnnTm" prepend="AND">
			         SUBSTR(USR_JOB_BGNN_TM, 1, 8) <![CDATA[ >=	]]> SUBSTR(#usrJobBgnnTm#, 1, 8)
			     </isNotEmpty>
			</isNotNull>
				 
			 <isNotNull property="usrJobEndTm">
			     <isNotEmpty property="usrJobEndTm" prepend="AND">
			        SUBSTR(USR_JOB_END_TM, 1, 8) <![CDATA[ <= ]]> SUBSTR(#usrJobEndTm#, 1, 8)
			     </isNotEmpty>
			 </isNotNull>
			 
			 <isNotEmpty property="deptCd" prepend="AND">
				<![CDATA[
					DEPT_CD
				]]>
				<iterate prepend="IN" property="deptCdArr" open="(" close=")" conjunction=",">
					#deptCdArr[]#
				</iterate>
			</isNotEmpty>  
	</select> 
	
	<!-- 사용자 ip, 접속시간, 접속기록 조회 쿼리 -->
	<select id="sysmHist0200DAO.selectHist0200List_D" parameterClass="sysmHist0200SrhVo" resultClass="egovMap">
		SELECT * FROM (
			SELECT A.*, ROWNUM RNUM 
				FROM (
					  SELECT DPOB_CD		
						, USR_JOB_YR		
						, USR_ID		
						, USR_JOB_SEIL_NUM			
						, USR_CONNECT_DIV_CD			
						, DEPT_CD	
						, fcBass0400CDNM(DPOB_CD, DEPT_CD,'2') AS DEPT_NM	
						, USR_DIV_CD				
						, USR_NM	
						, SYSTEMKEY			
						, SUBSTR(USR_JOB_DTNTM,1,14) AS USR_JOB_DTNTM		
						, USR_JOB_SEPT_DIV_CD		
						, USR_JOB_ETHD_NM				
						, SUBSTR(USR_JOB_BGNN_TM,1,14) AS USR_JOB_BGNN_TM				
						, SUBSTR(USR_JOB_END_TM,1,14) AS USR_JOB_END_TM			
						, KYBDR		
						, INPT_DT			
						, INPT_ADDR			
						, ISMT			
						, REVN_DT			
						, REVN_ADDR					
					  FROM HIST0200   
					  WHERE  1=1
				   	<isNotNull property="dpobCd">
					     <isNotEmpty property="dpobCd" prepend="AND">
							DPOB_CD = #dpobCd#
					     </isNotEmpty>
					 </isNotNull>
				   	
				   	<isNotNull property="usrConnectDivCd">
						<isNotEmpty property="usrConnectDivCd" prepend="AND">
							USR_CONNECT_DIV_CD = #usrConnectDivCd#
						</isNotEmpty>
					</isNotNull>
					 
					 <isNotNull property="systemkey">
					     <isNotEmpty property="systemkey" prepend="AND">
					        USR_ID = (SELECT  USR_ID FROM SYSM0200 WHERE DPOB_CD = #dpobCd# AND SYSTEMKEY= #systemkey#)
					     </isNotEmpty>
					 </isNotNull>
					 
					 <isNotNull property="usrJobEndTm">
					     <isNotEmpty property="usrJobEndTm" prepend="AND">
					        SUBSTR(USR_JOB_BGNN_TM, 1, 8) <![CDATA[ >= ]]> SUBSTR(#usrJobEndTm#, 1, 8)
					     </isNotEmpty>
					 </isNotNull>
					 
					 <isNotNull property="usrJobEndTm">
					     <isNotEmpty property="usrJobEndTm" prepend="AND">
					        SUBSTR(USR_JOB_END_TM, 1, 8) <![CDATA[ <=  ]]> SUBSTR(#usrJobEndTm#, 1, 8)
					     </isNotEmpty>
					 </isNotNull>
					 
					 <isNotEmpty property="deptCd" prepend="AND">
						<![CDATA[
							DEPT_CD
						]]>
						<iterate prepend="IN" property="deptCdArr" open="(" close=")" conjunction=",">
							#deptCdArr[]#
						</iterate>
					</isNotEmpty>  
				<![CDATA[					
			) A WHERE ROWNUM <= #lastIndex#
		)WHERE RNUM >= #firstIndex#
		]]>
	</select>

	<delete id="sysmHist0200DAO.deleteHist0200_S">
		<![CDATA[
			DELETE FROM HIST0200 
			WHERE  1=1
		]]>
		<isNotNull property="dpobCd">
			<isNotEmpty property="dpobCd" prepend="AND">
				DPOB_CD = #dpobCd#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="usrJobYr">
			<isNotEmpty property="usrJobYr" prepend="AND">
				USR_JOB_YR = #usrJobYr#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="usrId">
			<isNotEmpty property="usrId" prepend="AND">
				USR_ID = #usrId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="usrJobSeilNum">
			<isNotEmpty property="usrJobSeilNum" prepend="AND">
				USR_JOB_SEIL_NUM = #usrJobSeilNum#
			</isNotEmpty>
		</isNotNull>
				
	</delete>
	
	<!-- 점검내역 엑셀 추가_hieju 07.28 -->
	<select id="sysmHist0200DAO.selectXlsSysm3200List_S" parameterClass="sysmHist0200SrhVo" resultClass="egovMap">
	
			SELECT
		    A.TABLESPACE_NAME AS TABLESPACENM,
		    A.FILE_NAME AS FILENM,
		    (A.BYTES - B.FREE) AS BYTESB,
		    B.FREE,
		    A.BYTES,
		   	TO_CHAR( (B.FREE / A.BYTES * 100) , '999.99')||'%' AS PERCENTAGE
				FROM
		    (SELECT FILE_ID, TABLESPACE_NAME, FILE_NAME, SUBSTR(FILE_NAME, 1, 200) AS FILE_NM, SUM(BYTES) AS BYTES
		     FROM DBA_DATA_FILES
		     GROUP BY FILE_ID, TABLESPACE_NAME, FILE_NAME, SUBSTR(FILE_NAME, 1, 200)
		    ) A,
		    (SELECT TABLESPACE_NAME, FILE_ID, SUM(NVL(BYTES, 0)) AS FREE
		     FROM DBA_FREE_SPACE
		     GROUP BY TABLESPACE_NAME, FILE_ID
		    ) B
				WHERE
		    A.TABLESPACE_NAME = B.TABLESPACE_NAME
		    AND A.FILE_ID = B.FILE_ID
		    
 
 	</select>
 	
 	<select id="sysmHist0200DAO.selectXlsFileSysm3200List_S" parameterClass="sysmHist0200SrhVo" resultClass="egovMap">
	
		SELECT    
			A.TABLESPACE_NAME,
        	A.FILE_NAME,
           (A.BYTES - B.FREE) AS BYTESB,
            B.FREE,
            A.BYTES,
           	TO_CHAR( (B.FREE / A.BYTES * 100) , '999.99')||'%' AS PERCENTAGE
      FROM
       (
         SELECT FILE_ID,
                TABLESPACE_NAME,
                FILE_NAME,
                SUBSTR(FILE_NAME,1,200) FILE_NM,
                SUM(BYTES) BYTES
           FROM DBA_DATA_FILES
         GROUP BY FILE_ID,TABLESPACE_NAME,FILE_NAME,SUBSTR(FILE_NAME,1,200)
       ) A,
       (
         SELECT TABLESPACE_NAME,
                FILE_ID,
                SUM(NVL(BYTES,0)) FREE
           FROM DBA_FREE_SPACE
        GROUP BY TABLESPACE_NAME,FILE_ID
       ) B
      WHERE A.TABLESPACE_NAME=B.TABLESPACE_NAME
         AND A.FILE_ID = B.FILE_ID
         
 	</select>
	
	

</sqlMap>
