<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Psnl0110">

	<typeAlias alias="hashMap" type="java.util.HashMap"/>
    <typeAlias alias="list" type="java.util.List"/>
    <typeAlias alias="int" type="java.lang.Integer"/>
    <typeAlias alias="string" type="java.lang.String"/>
	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	
	<typeAlias alias="infcPsnl0110Dto" type="com.app.exterms.personal.client.dto.InfcPsnl0110DTO"/>
	<typeAlias  alias="infcPsnl0110SerarchVO" type="com.app.exterms.personal.server.vo.InfcPsnl0110DefaultVO"/>
	
	<resultMap id="infcPsnl0110" class="com.app.exterms.personal.server.vo.InfcPsnl0110VO">
		<result property="dpobCd" column="DPOB_CD" columnIndex="1"/>
		<result property="systemkey" column="SYSTEMKEY" columnIndex="2"/>
		<result property="emymtSeilNum" column="EMYMT_SEIL_NUM" columnIndex="3"/>
		<result property="emymtDivCd" column="EMYMT_DIV_CD" columnIndex="4"/>
		<result property="emymtTypCd" column="EMYMT_TYP_CD" columnIndex="5"/>
		<result property="emymtBgnnDt" column="EMYMT_BGNN_DT" columnIndex="6"/>
		<result property="emymtEndDt" column="EMYMT_END_DT" columnIndex="7"/>
		<result property="deptCd" column="DEPT_CD" columnIndex="8"/>
		<result property="currPaeWorkNm" column="CURR_PAE_WORK_NM" columnIndex="9"/>
		<result property="businCd" column="BUSIN_CD" columnIndex="10"/>
		<result property="typOccuCd" column="TYP_OCCU_CD" columnIndex="11"/>
		<result property="dtilOccuClsDivCd" column="DTIL_OCCU_CLS_DIV_CD" columnIndex="12"/>
		<result property="odtyCd" column="ODTY_CD" columnIndex="13"/>
		<result property="payPymtDivCd" column="PAY_PYMT_DIV_CD" columnIndex="14"/>
		<result property="emymtSum" column="EMYMT_SUM" columnIndex="15"/>
		<result property="emymtReasCtnt" column="EMYMT_REAS_CTNT" columnIndex="16"/>
		<result property="certNumHuhd" column="CERT_NUM_HUHD" columnIndex="17"/>
		<result property="rducBgnnDt" column="RDUC_BGNN_DT" columnIndex="18"/>
		<result property="kybdr" column="KYBDR" columnIndex="19"/>
		<result property="inptDt" column="INPT_DT" columnIndex="20"/>
		<result property="inptAddr" column="INPT_ADDR" columnIndex="21"/>
		<result property="ismt" column="ISMT" columnIndex="22"/>
		<result property="revnDt" column="REVN_DT" columnIndex="23"/>
		<result property="revnAddr" column="REVN_ADDR" columnIndex="24"/>
		<result property="rducEndDt" column="RDUC_END_DT" columnIndex="25"/> 
	</resultMap>
	
	<update id="infcPsnl0110DAO.mergeIntoPayr0500" parameterClass="infcPsnl0110Dto" >
	    MERGE INTO PAYR0500
                 USING DUAL
                    ON (DPOB_CD = #dpobCd# AND SYSTEMKEY = #systemkey#)
            WHEN MATCHED
            THEN
               UPDATE SET PAYR_MANG_DEPT_CD = (SELECT B.PAYR_MANG_DEPT_CD 
               									 FROM PSNL0100 A, BASS0400 B 
                                                WHERE 1=1  
                                                  AND A.DPOB_CD = #dpobCd#
                                                  AND A.SYSTEMKEY = #systemkey#
                                                  AND A.DPOB_CD  = B.DPOB_CD
                                                  AND A.CURR_AFFN_DEPT_CD = B.DEPT_CD
                                                  AND ROWNUM = 1)
                        , EMYMT_DIV_CD = #emymtDivCd#
                        , ISMT=#ismt#
                        , REVN_DT= TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
                        , REVN_ADDR=#revnAddr#
           WHEN NOT MATCHED
            THEN
               INSERT 
                        ( DPOB_CD
                          , SYSTEMKEY
                          , PAYR_MANG_DEPT_CD
                          , EMYMT_DIV_CD
                          , PAY_RCPT_YN
                          , KYBDR
                          , INPT_DT
                          , INPT_ADDR
                          , ISMT
                          , REVN_DT
                          , REVN_ADDR )
                VALUES ( #dpobCd#
                          , #systemkey#
                          , (SELECT B.PAYR_MANG_DEPT_CD 
						 	   FROM PSNL0100 A, BASS0400 B 
                              WHERE 1=1  
                                AND A.DPOB_CD = #dpobCd#
                                AND A.SYSTEMKEY = #systemkey#
                                AND A.DPOB_CD  = B.DPOB_CD
                                AND A.CURR_AFFN_DEPT_CD = B.DEPT_CD
                                AND ROWNUM = 1)
                          , #emymtDivCd#
                          , 'Y'
                          , #ismt#
                          , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
                          , #revnAddr#
                          , #ismt#
                          , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
                          , #revnAddr# )
	</update>	

	
	<update id="infcPsnl0110DAO.updateYearMst" parameterClass="hashMap">
	    UPDATE PSNL0100
		SET LOG_SVC_YR_NUM_CD = (SELECT COMM_CD FROM BASS0300
		                                        WHERE RPSTTV_CD ='A007'
		                                            AND MANGE_ITEM01 = #year#)
		WHERE DPOB_CD = #dpobCd#
		    AND SYSTEMKEY = #systemkey#
	</update>
	
	<update id="infcPsnl0110DAO.updateMonthMst" parameterClass="hashMap">
	    UPDATE PSNL0100
		SET LOG_SVC_MNTH_ICM_CD = (SELECT COMM_CD FROM BASS0300
		                                                WHERE RPSTTV_CD ='A006'
		                                                    AND MANGE_ITEM01 = #month#)
		WHERE DPOB_CD = #dpobCd#
		    AND SYSTEMKEY = #systemkey#
	</update>
	
	<select id="infcPsnl0110DAO.getLogSvcData" resultClass="egovMap" parameterClass="infcPsnl0110Dto" >
	    SELECT SERVC_RCGTN_PRID_CD,
		       DSAGE_DT,
		       ENRLNT_DT,
		       DIFF_MONTHS,
		       DIFF_YEAR,
		       DIFF_MONTH
		  FROM (SELECT SERVC_RCGTN_PRID_CD,
		               DSAGE_DT,
		               ENRLNT_DT,
		               TRIM (
		                  TO_CHAR (
		                     (TO_DATE (DSAGE_DT, 'YYYYMMDD')
		                      - TO_DATE (ENRLNT_DT, 'YYYYMMDD'))
		                     / 365
		                     * 12,
		                     '9999999999'))
		                  AS DIFF_MONTHS,
		               DECODE (
		                  LENGTH (
		                     (TO_DATE (DSAGE_DT, 'YYYYMMDD')
		                      - TO_DATE (ENRLNT_DT, 'YYYYMMDD')) YEAR TO MONTH),
		                  6, SUBSTR (
		                        (TO_DATE (DSAGE_DT, 'YYYYMMDD')
		                         - TO_DATE (ENRLNT_DT, 'YYYYMMDD')) YEAR TO MONTH,
		                        2,
		                        2),
		                  '')
		                  AS DIFF_YEAR,
		               DECODE (
		                  LENGTH (
		                     (TO_DATE (DSAGE_DT, 'YYYYMMDD')
		                      - TO_DATE (ENRLNT_DT, 'YYYYMMDD')) YEAR TO MONTH),
		                  6, SUBSTR (
		                        (TO_DATE (DSAGE_DT, 'YYYYMMDD')
		                         - TO_DATE (ENRLNT_DT, 'YYYYMMDD')) YEAR TO MONTH,
		                        5,
		                        2),
		                  '')
		                  AS DIFF_MONTH
		          FROM PSNL0112
		         WHERE     1 = 1
		               AND SERVC_RCGTN_PRID_CD &lt;&gt; 'A0290000'
		               AND SYSTEMKEY = #systemkey#
		               AND DPOB_CD = #dpobCd# )
	</select>
	
	
	<update id="infcPsnl0110DAO.updateEmymtEndDate" parameterClass="infcPsnl0110Dto">
	    UPDATE PSNL0110 A
		   SET A.EMYMT_END_DT =
		          TO_CHAR (TO_DATE (TO_CHAR(#emymtBgnnDt#,'YYYYMMDD'), 'yyyymmdd') - 1, 'yyyymmdd')
		 WHERE A.DPOB_CD = #dpobCd# AND A.SYSTEMKEY = #systemkey#
		       AND A.EMYMT_BGNN_DT =
		              (SELECT MAX (EMYMT_BGNN_DT)
		                 FROM PSNL0110 B
		                WHERE     A.DPOB_CD = B.DPOB_CD
		                      AND A.SYSTEMKEY = B.SYSTEMKEY
		                      AND EMYMT_BGNN_DT &lt;&gt; TO_CHAR(#emymtBgnnDt#,'YYYYMMDD'))
	</update>
	
	<insert id="infcPsnl0110DAO.insertPsnl0110" parameterClass="infcPsnl0110Dto">
		<![CDATA[
			INSERT INTO PSNL0110 
				( DPOB_CD
				  , SYSTEMKEY
				  , EMYMT_SEIL_NUM
				  , EMYMT_DIV_CD
				  , EMYMT_TYP_CD
				  , EMYMT_BGNN_DT
				  , EMYMT_END_DT
				  , DEPT_CD
				  , CURR_PAE_WORK_NM
				  , BUSIN_CD
				  , TYP_OCCU_CD
				  , DTIL_OCCU_CLS_DIV_CD
				  , ODTY_CD
				  , PAY_PYMT_DIV_CD
				  , EMYMT_SUM
				  , EMYMT_REAS_CTNT
				  , CERT_NUM_HUHD
				  , RDUC_BGNN_DT
				  , KYBDR
				  , INPT_DT
				  , INPT_ADDR
				  , ISMT
				  , REVN_DT
				  , REVN_ADDR
				  , RDUC_END_DT
				  , PYSP_GRDE_CD )
			VALUES ( #dpobCd#
				  , #systemkey#
				  , (select NVL(MAX(EMYMT_SEIL_NUM)+1,1) from PSNL0110 WHERE DPOB_CD = #dpobCd# AND SYSTEMKEY = #systemkey#) 
				  , #emymtDivCd#
				  , #emymtTypCd#
				  , TO_CHAR(#emymtBgnnDt#,'YYYYMMDD')
				  , TO_CHAR(#emymtEndDt#, 'YYYYMMDD')
				  , #deptCd#
				  , #currPaeWorkNm#
				  , #businCd#
				  , #typOccuCd#
				  , #tempDtilOccuClsDivCd#
				  , #odtyCd#
				  , #payPymtDivCd#
				  , #emymtSum#
				  , #emymtReasCtnt#
				  , #certNumHuhd#
				  , #rducBgnnDt#
				  , #ismt#
				  , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				  , #revnAddr#
				  , #ismt#
				  , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				  , #revnAddr#
				  , #rducEndDt#
				  , #pyspGrdeCd# )
		]]>
	</insert>
	
	<update id="infcPsnl0110DAO.updatePsnl0110" parameterClass="infcPsnl0110Dto">
		
			UPDATE PSNL0110
			SET REVN_DT= TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
		<isNotNull property="emymtDivCd"><isNotEmpty property="emymtDivCd">, EMYMT_DIV_CD=#emymtDivCd#</isNotEmpty></isNotNull>
		<isNotNull property="emymtTypCd"><isNotEmpty property="emymtTypCd">, EMYMT_TYP_CD=#emymtTypCd#</isNotEmpty></isNotNull>
		<isNotNull property="emymtBgnnDt"><isNotEmpty property="emymtBgnnDt">, EMYMT_BGNN_DT= to_char(#emymtBgnnDt#,'yyyymmdd')</isNotEmpty></isNotNull>
		<isNotNull property="emymtEndDt"><isNotEmpty property="emymtEndDt">, EMYMT_END_DT= to_char(#emymtEndDt#,'yyyymmdd')</isNotEmpty></isNotNull>
		<isNotNull property="deptCd"><isNotEmpty property="deptCd">, DEPT_CD=#deptCd#</isNotEmpty></isNotNull>
		<isNotNull property="currPaeWorkNm"><isNotEmpty property="currPaeWorkNm">, CURR_PAE_WORK_NM=#currPaeWorkNm#</isNotEmpty></isNotNull>
		<isNotNull property="businCd"><isNotEmpty property="businCd">, BUSIN_CD=#businCd#</isNotEmpty></isNotNull>
		<isNotNull property="typOccuCd"><isNotEmpty property="typOccuCd">, TYP_OCCU_CD=#typOccuCd#</isNotEmpty></isNotNull>
		<isNotNull property="tempDtilOccuClsDivCd"><isNotEmpty property="tempDtilOccuClsDivCd">, DTIL_OCCU_CLS_DIV_CD=#tempDtilOccuClsDivCd#</isNotEmpty></isNotNull>
		<isNotNull property="odtyCd"><isNotEmpty property="odtyCd">, ODTY_CD=#odtyCd#</isNotEmpty></isNotNull>
		<isNotNull property="payPymtDivCd"><isNotEmpty property="payPymtDivCd">, PAY_PYMT_DIV_CD=#payPymtDivCd#</isNotEmpty></isNotNull>
		<isNotNull property="emymtSum"><isNotEmpty property="emymtSum">, EMYMT_SUM=#emymtSum#</isNotEmpty></isNotNull>
		<isNotNull property="emymtReasCtnt"><isNotEmpty property="emymtReasCtnt">, EMYMT_REAS_CTNT=#emymtReasCtnt#</isNotEmpty></isNotNull>
		<isNotNull property="certNumHuhd"><isNotEmpty property="certNumHuhd">, CERT_NUM_HUHD=#certNumHuhd#</isNotEmpty></isNotNull>
		<isNotNull property="rducBgnnDt"><isNotEmpty property="rducBgnnDt">, RDUC_BGNN_DT=#rducBgnnDt#</isNotEmpty></isNotNull>
		<isNotNull property="rducEndDt"><isNotEmpty property="rducEndDt">, RDUC_END_DT=#rducEndDt#</isNotEmpty></isNotNull>
		<isNotNull property="ismt"><isNotEmpty property="ismt">, ISMT=#ismt#</isNotEmpty></isNotNull>
		<isNotNull property="revnAddr"><isNotEmpty property="revnAddr">, REVN_ADDR=#revnAddr#</isNotEmpty></isNotNull>
		<isNotNull property="pyspGrdeCd"><isNotEmpty property="pyspGrdeCd">, PYSP_GRDE_CD=#pyspGrdeCd#</isNotEmpty></isNotNull>
		WHERE DPOB_CD=#dpobCd#
		AND SYSTEMKEY=#systemkey#
		AND EMYMT_SEIL_NUM=#emymtSeilNum#
	</update>

	<delete id="infcPsnl0110DAO.deletePsnl0110" parameterClass="infcPsnl0110Dto">

		DELETE FROM PSNL0110
		WHERE DPOB_CD=#dpobCd#
		AND
		SYSTEMKEY=#systemkey#
		AND EMYMT_SEIL_NUM=#emymtSeilNum#

	</delete>

	<select id="infcPsnl0110DAO.selectPsnl0110" resultClass="egovMap" parameterClass="hashMap">
		
			SELECT
				DPOB_CD
				, SYSTEMKEY
				, EMYMT_SEIL_NUM
				, EMYMT_DIV_CD
				, EMYMT_TYP_CD
				, TO_DATE(EMYMT_BGNN_DT,'YYYYMMDD') EMYMT_BGNN_DT
				, TO_DATE(EMYMT_END_DT,'YYYYMMDD') EMYMT_END_DT
				, DEPT_CD
				, fcBass0400CDNM(DPOB_CD,DEPT_CD,'2') AS DEPT_NM
				, CURR_PAE_WORK_NM
				, BUSIN_CD 
				, DECODE(NVL(TYP_OCCU_CD,''),'','',(TYP_OCCU_CD || '!' || NVL(PYSP_GRDE_CD,'A0060000')) )   AS TYP_OCCU_CD  
				, DTIL_OCCU_CLS_DIV_CD
				, ODTY_CD
				, PAY_PYMT_DIV_CD
				, EMYMT_SUM
				, EMYMT_REAS_CTNT
				, CERT_NUM_HUHD
				, RDUC_BGNN_DT
				, KYBDR
				, INPT_DT
				, INPT_ADDR
				, ISMT
				, REVN_DT
				, REVN_ADDR
				, RDUC_END_DT
				, NVL(PYSP_GRDE_CD,'A0060000') AS PYSP_GRDE_CD
			FROM PSNL0110
			WHERE DPOB_CD=#dpobCd#
			AND SYSTEMKEY=#systemkey#
			
		<isNotNull property="emymtSeilNum">
			<isNotEmpty property="emymtSeilNum">
				AND EMYMT_SEIL_NUM=#emymtSeilNum#
			</isNotEmpty>
		</isNotNull>
		
		ORDER BY EMYMT_BGNN_DT DESC
		
	</select>



</sqlMap>
