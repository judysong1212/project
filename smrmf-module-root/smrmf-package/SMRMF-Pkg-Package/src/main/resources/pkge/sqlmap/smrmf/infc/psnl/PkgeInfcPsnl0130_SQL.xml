<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PkgeInfcPsnl0130">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="infcPkgPsnl0130SrhVO" type="com.app.smrmf.infc.personal.server.vo.InfcPkgPsnl0130SrhVO"/>
	<typeAlias  alias="infcPkgPsnl0130Vo" type="com.app.smrmf.infc.personal.server.vo.InfcPkgPsnl0130VO"/>
	
	<resultMap id="infcPkgPsnl0130" class="com.app.smrmf.infc.personal.server.vo.InfcPkgPsnl0130VO">
		<result property="systemkey"	column="SYSTEMKEY"		columnIndex="1"/>
		<result property="dpobCd"		column="DPOB_CD"		columnIndex="2"/>
		<result property="payCd"		column="PAY_CD"			columnIndex="3"/>
		<result property="bnkCd"		column="BNK_CD"			columnIndex="4"/>
		<result property="bnkAccuNum"	column="BNK_ACCU_NUM"	columnIndex="5"/>
		<result property="acntHodrNm"	column="ACNT_HODR_NM"	columnIndex="6"/>
		<result property="rpsttvAccuYn"	column="RPSTTV_ACCU_YN"	columnIndex="7"/>
		<result property="accuNoteCtnt"	column="ACCU_NOTE_CTNT"	columnIndex="8"/>
		<result property="kybdr"		column="KYBDR"			columnIndex="9"/>
		<result property="inptDt"		column="INPT_DT"		columnIndex="10"/>
		<result property="inptAddr"		column="INPT_ADDR"		columnIndex="11"/>
		<result property="ismt"			column="ISMT"			columnIndex="12"/>
		<result property="revnDt"		column="REVN_DT"		columnIndex="13"/>
		<result property="revnAddr"		column="REVN_ADDR"		columnIndex="14"/>
		<result property="resnRegnNum"	column="RESN_REGN_NUM"	columnIndex="15"/>
		<result property="resnRegnGbn"	column="RESN_REGN_GBN"	columnIndex="16"/>
		<result property="hanNm"		column="HAN_NM"			columnIndex="17"/>
		<result property="payNm"		column="PAY_NM"			columnIndex="18"/>
		<result property="bnkNm"		column="BNK_NM"			columnIndex="19"/>
	</resultMap>
	
	<insert id="infcPkgPsnl0130DAO.insertPsnl0130_S">
		<![CDATA[
			INSERT INTO PSNL0130 
				( SYSTEMKEY
				  , DPOB_CD
				  , PAY_CD
				  , BNK_CD
				  , BNK_ACCU_NUM
				  , ACNT_HODR_NM
				  , RPSTTV_ACCU_YN
				  , ACCU_NOTE_CTNT
				  , KYBDR
				  , INPT_DT
				  , INPT_ADDR
				  , ISMT
				  , REVN_DT
				  , REVN_ADDR )
			VALUES ( #systemkey#
				  , #dpobCd#
				  , #payCd#
				  , #bnkCd#
				  , REPLACE(#bnkAccuNum#,'-','')
				  , #acntHodrNm#
				  , #rpsttvAccuYn#
				  , #accuNoteCtnt#
				  , #kybdr#
				  , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				  , #inptAddr#
				  , #ismt#
				  , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				  , #revnAddr# )
		]]>
	</insert>
	
	<update id="infcPkgPsnl0130DAO.updatePsnl0130_S">
		<![CDATA[
			UPDATE PSNL0130
			SET SYSTEMKEY=#systemkey#
				, DPOB_CD=#dpobCd#
				, PAY_CD=#payCd#
				, BNK_CD=#bnkCd#
				, BNK_ACCU_NUM=REPLACE(#bnkAccuNum#,'-','')
				, ACNT_HODR_NM=#acntHodrNm#
				, RPSTTV_ACCU_YN=#rpsttvAccuYn#
				, ACCU_NOTE_CTNT=#accuNoteCtnt#
				, ISMT=#ismt#
				, REVN_DT=TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				, REVN_ADDR=#revnAddr#
						WHERE SYSTEMKEY=#systemkey#
								AND DPOB_CD=#dpobCd#
								AND PAY_CD=#payCd#
				]]>
	</update>
	
	<delete id="infcPkgPsnl0130DAO.deletePsnl0130_S">
		<![CDATA[
			DELETE
			FROM   PSNL0130 
			WHERE  SYSTEMKEY =#systemkey#
				AND	   DPOB_CD	 = #dpobCd#
				AND	   PAY_CD	 = #payCd#
		]]>
	</delete>
	
	<select id="infcPkgPsnl0130DAO.selectPsnl0130_S"  resultMap="infcPkgPsnl0130">
		<![CDATA[
			SELECT
				SYSTEMKEY
				, DPOB_CD
				, PAY_CD
				, BNK_CD
				, BNK_ACCU_NUM
				, ACNT_HODR_NM
				, RPSTTV_ACCU_YN
				, ACCU_NOTE_CTNT
				, KYBDR
				, INPT_DT
				, INPT_ADDR
				, ISMT
				, REVN_DT
				, REVN_ADDR
			FROM PSNL0130
						WHERE SYSTEMKEY=#systemkey#
								AND DPOB_CD=#dpobCd#
								AND PAY_CD=#payCd#
				]]>
	</select>
	
	<select id="infcPkgPsnl0130DAO.selectPayr1700ToPsnl0130_S" parameterClass="infcPkgPsnl0130Vo" resultClass="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM PSNL0130
				WHERE SYSTEMKEY=#systemkey#
					AND DPOB_CD=#dpobCd#
					AND PAY_CD=#payCd#
		]]>
					<isNotEmpty prepend="AND" property="bnkCd" >
			 			BNK_CD=#bnkCd#
		       		</isNotEmpty>
		            <isNotEmpty prepend="AND" property="bnkAccuNum" >
			 			BNK_ACCU_NUM=#bnkAccuNum#
		       		</isNotEmpty>
					<isNotEmpty prepend="AND" property="acntHodrNm" >
			 			ACNT_HODR_NM=#acntHodrNm#
		       		</isNotEmpty>
	</select>
	
	<select id="infcPkgPsnl0130DAO.selectPsnl0130List_D" parameterClass="infcPkgPsnl0130SrhVO" resultClass="egovMap">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT
								 SYSTEMKEY
								, DPOB_CD
								, PAY_CD
							    , PAY_CD AS payCdcommCd 
								, fcBass0300CDNM(DPOB_CD,PAY_CD) AS payCdcommCdNm 
								, BNK_CD
								, BNK_CD AS bnkCdcommCd 
								, fcBass0300CDNM(DPOB_CD,BNK_CD) AS bnkCdcommCdNm 
								, BNK_ACCU_NUM
								, ACNT_HODR_NM
								, RPSTTV_ACCU_YN
								, ACCU_NOTE_CTNT
								, KYBDR
								, INPT_DT
								, INPT_ADDR
								, ISMT
								, REVN_DT
								, REVN_ADDR
						FROM PSNL0130
				WHERE 1=1
					<isNotEmpty prepend="AND" property="dpobCd" >
			 			DPOB_CD=#dpobCd#
		       		</isNotEmpty>
		            <isNotEmpty prepend="AND" property="systemkey" >
			 			SYSTEMKEY=#systemkey#
		       		</isNotEmpty>
					ORDER BY 
						SYSTEMKEY DESC
							, DPOB_CD DESC
							, PAY_CD DESC
		<![CDATA[					
				) A WHERE ROWNUM <= #lastIndex#
			)WHERE RNUM >= #firstIndex#
		]]>
	</select>
	
	
	<select id="infcPkgPsnl0130DAO.selectPsnl0130ListTotCnt_S" parameterClass="infcPkgPsnl0130SrhVO" resultClass="int">
		SELECT COUNT(*) totcnt
		FROM PSNL0130
		WHERE 1=1
		<isNotEmpty prepend="AND" property="dpobCd" >
			DPOB_CD=#dpobCd#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="systemkey" >
			SYSTEMKEY=#systemkey#
		</isNotEmpty>
	</select>
	
	<!-- ########## 엑셀 업로드 ##########  -->
	<delete id="infcPkgPsnl0130DAO.deleteXlsPayr1700">
		<![CDATA[
			DELETE FROM PSNL0130
			WHERE  DPOB_CD	 = #dpobCd#
		]]>
			<isEqual property="resnRegnGbn" compareValue="Y">
				AND	SYSTEMKEY = (SELECT SYSTEMKEY
								 FROM	PSNL0100 
								 WHERE	RESN_REGN_NUM = REPLACE(#resnRegnNum#, '-', '')
								)  
			</isEqual>
			<isEqual property="resnRegnGbn" compareValue="N">
				AND SYSTEMKEY = (SELECT SYSTEMKEY
								 FROM	PSNL0100 
								 WHERE	HAN_NM = #hanNm#
								 AND    SUBSTR(RESN_REGN_NUM,1,6) = (CASE 
		            													WHEN LENGTH(REPLACE(#resnRegnNum#, '-', '')) = 6 THEN REPLACE(#resnRegnNum#, '-', '')
		            													WHEN LENGTH(REPLACE(#resnRegnNum#, '-', '')) = 8 THEN SUBSTR(REPLACE(#resnRegnNum#, '-', ''),3,6)
		            									 			    END)
								)
			</isEqual>
			<isNotEmpty property="payCd">
				AND	PAY_CD = #payCd#	    
		  	</isNotEmpty>
		  	<isEmpty property="payCd">
				AND	PAY_CD = (SELECT COMM_CD 
							  FROM	  BASS0300
							  WHERE  RPSTTV_CD = 'B015'
							  AND	  COMM_CD_NM = #payNm#
							 )
		  	</isEmpty>
		  	
	</delete>
	
	<insert id="infcPkgPsnl0130DAO.insertXlsPayr1700">
		<![CDATA[
			INSERT INTO PSNL0130 
				   (
					SYSTEMKEY
				  , DPOB_CD
				  , PAY_CD
				  , BNK_CD
				  , BNK_ACCU_NUM
				  , ACNT_HODR_NM
				  , RPSTTV_ACCU_YN
				  , ACCU_NOTE_CTNT
				  , KYBDR
				  , INPT_DT
				  , INPT_ADDR
				  , ISMT
				  , REVN_DT
				  , REVN_ADDR
				   )
			VALUES (
					]]>
					<isEqual property="resnRegnGbn" compareValue="Y">
						(SELECT SYSTEMKEY
						 FROM	PSNL0100 
						 WHERE	RESN_REGN_NUM = REPLACE(#resnRegnNum#, '-', '')
						)  
					</isEqual>
					<isEqual property="resnRegnGbn" compareValue="N">
					    (SELECT SYSTEMKEY
  						 FROM   PSNL0100
 						 WHERE  HAN_NM = #hanNm#
       					 AND    SUBSTR(RESN_REGN_NUM,1,6) = (CASE 
            													WHEN LENGTH(REPLACE(#resnRegnNum#, '-', '')) = 6 THEN REPLACE(#resnRegnNum#, '-', '')
            													WHEN LENGTH(REPLACE(#resnRegnNum#, '-', '')) = 8 THEN SUBSTR(REPLACE(#resnRegnNum#, '-', ''),3,6)
            									 			END)
						)
					</isEqual>
					<![CDATA[
				  , #dpobCd#
				  	]]>
				  	<isNotEmpty property="payCd">
				  		, #payCd#	    
				  	</isNotEmpty>
				  	<isEmpty property="payCd">
				  	    , (SELECT COMM_CD 
						   FROM	  BASS0300
						   WHERE  RPSTTV_CD = 'B015'
						   <!--  AND	  COMM_CD_NM = #payNm#-->
				  	      )
				  	 </isEmpty>
					  	<isNotEmpty property="bnkCd">
					  	    , (SELECT COMM_CD
							   FROM	  BASS0300
							   WHERE  RPSTTV_CD = 'B001'
							   	AND	  MANGE_ITEM11 = #bnkCd#
							   	AND   OPN_YN = 'Y'
							   	AND   USE_YN = 'Y'
							   	AND   MANGE_ITEM01 = 'Y'
							   <!--  AND	  COMM_CD_NM = #bnkNm# -->
							  )
					  	</isNotEmpty>
				  	<isEmpty property="bnkCd">
				  	    , (SELECT COMM_CD
						   FROM	  BASS0300
						   WHERE  RPSTTV_CD = 'B001'
						   	AND	  COMM_CD_NM = #bnkNm#  
						   	AND   OPN_YN = 'Y'
							AND   USE_YN = 'Y'
							AND   MANGE_ITEM01 = 'Y'
						  )
				  	</isEmpty>
				  <![CDATA[
				  , REPLACE(#bnkAccuNum#,'-','')
				  , #acntHodrNm#
				  ]]>
				  <isEqual property="payCd" compareValue="B0150000">
				      , 'Y'
				  </isEqual>
				  <isNotEqual property="payCd" compareValue="B0150000">
				      , #rpsttvAccuYn#
				  </isNotEqual>
				  <![CDATA[
				  , #accuNoteCtnt#
				  , #kybdr#
				  , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				  , #inptAddr#
				  , #ismt#
				  , TO_CHAR(SYSDATE,'YYYYMMDDHHMISS')
				  , #revnAddr#
				   )
		]]>
	</insert>
	
	
	
	<!-- 엑셀 다운(상단) -->
	<select id="infcPkgPsnl0130DAO.selectXlsPayr1700List" parameterClass="infcPkgPsnl0130SrhVO" resultClass="egovMap">
		SELECT A.DPOB_CD,
				         A.SYSTEMKEY,
				         A.HAN_NM,
				         A.ENG_NM,
				         A.CHIN_CHAR_NM,
				         A.RESN_REGN_NUM,
				         A.SX_DIV_CD,
				         A.YOOBH_MNTH_DAY,
				         A.SCLC_DIV_CD,
				         A.NATN_CD,
				         A.DEPT_CD,
				         fcBass0400CDNM (A.DPOB_CD, A.DEPT_CD, '2') AS DEPT_NM,
				         A.BUSIN_CD,
				         A.CURR_AFFN_DEPT_CD,
				         fcBass0400CDNM (A.DPOB_CD, A.CURR_AFFN_DEPT_CD, '2') AS CURR_AFFN_DEPT_NM,
				         A.REPBTY_BUSIN_DIV_CD,
				         A.TYP_OCCU_CD,
				         fcBass0320CDNM (A.DPOB_CD, A.TYP_OCCU_CD) AS TYP_OCCU_NM,
				         A.ODTY_CD,
				         fcBass0300CDNM (A.DPOB_CD, A.ODTY_CD) AS ODTY_NM,
				         A.FRST_EMYMT_DT,
				         A.EMYMT_DIV_CD,
				         fcBass0300CDNM (A.DPOB_CD, A.EMYMT_DIV_CD) AS EMYMT_DIV_NM,
				         A.EMYMT_DIV_CD AS emymtDivCdcommCd,
				         fcBass0300CDNM (A.DPOB_CD, A.EMYMT_DIV_CD)AS emymtDivCdcommCdNm,
				         A.EMYMT_BGNN_DT,
				         A.EMYMT_END_DT,
				         A.PYSP_CD,
				         fcBass0300CDNM (A.DPOB_CD, A.PYSP_CD) AS PYSP_NM,
				         A.HDOFC_CODTN_CD,
				         A.RETRY_DT,
				         A.RETRY_REAS_CTNT,
				         A.FRGNR_DIV_CD,
				         A.PSPT_NUM,
				         A.STY_BGNN_DT,
				         A.STY_END_DT,
				         A.END_SCHL,
				         A.END_DEGR_DIV_CD,
				         A.PMTN_SCDU_DT,
				         A.PYSP_PRMTN_SCDU_DT,
				         A.REYMN_SCDU_DT,
				         A.LOG_SVC_YR_NUM_CD,
				         fcBass0300CDNM (A.DPOB_CD, A.LOG_SVC_YR_NUM_CD)
				            AS LOG_SVC_YR_NUM_NM,
				         A.LOG_SVC_MNTH_ICM_CD,
				            (SELECT COMM_CD_NM
				               FROM BASS0300 C
				              WHERE C.COMM_CD = A.LOG_SVC_YR_NUM_CD)
				         || ' '
				         || (SELECT COMM_CD_NM
				               FROM BASS0300 C
				              WHERE C.COMM_CD = A.LOG_SVC_MNTH_ICM_CD)AS LOG_SVC_MNTH_ICM_NM,
				         A.CURR_PYSP_APPMT_DT,
				         A.CURR_DEPT_APPMT_DT,
				         A.PERN_NOTE_CTNT,
				         A.KYBDR,
				         A.INPT_DT,
				         A.INPT_ADDR,
				         A.ISMT,
				         A.REVN_DT,
				         A.REVN_ADDR,
				         (SELECT MAX (B.CURR_PAE_WORK_NM)
				            FROM PSNL0110 B
				           WHERE B.DPOB_CD = A.DPOB_CD AND B.SYSTEMKEY = A.SYSTEMKEY)
				            AS CURR_PAE_WORK_NM,
				         (SELECT MAX (C.PIC_FLNM)
				            FROM PSNL0125 C
				           WHERE C.DPOB_CD = A.DPOB_CD AND C.SYSTEMKEY = A.SYSTEMKEY)
				            AS PIC_FLNM,
				         A.PYSP_GRDE_CD,
				         fcBass0300CDNM (A.DPOB_CD, A.PYSP_GRDE_CD) AS PYSP_GRDE_NM,
				         A.DTIL_OCCU_CLS_DIV_CD,
				         A.DTIL_OCCU_INTTN_CD,
				         fcBassEx0350CDNM (A.DPOB_CD,
				                           A.TYP_OCCU_CD,
				                           A.DTIL_OCCU_INTTN_CD,
				                           '1')
				            AS DTIL_OCCU_CLS_DIV_NM,
				            '('
				         || (SELECT BUSIN_APPTN_YR
				               FROM BASS0500
				              WHERE     A.DPOB_CD = DPOB_CD
				                    AND A.CURR_AFFN_DEPT_CD = DEPT_CD
				                    AND A.BUSIN_CD = BUSIN_CD
				                    AND SUBSTR (A.EMYMT_BGNN_DT, 1, 4) = BUSIN_APPTN_YR)
				         || ')'
				         || (SELECT BUSIN_NM
				               FROM BASS0500
				              WHERE     A.DPOB_CD = DPOB_CD
				                    AND A.CURR_AFFN_DEPT_CD = DEPT_CD
				                    AND A.BUSIN_CD = BUSIN_CD
				                    AND SUBSTR (A.EMYMT_BGNN_DT, 1, 4) = BUSIN_APPTN_YR)
				            AS BUSIN_NM,
				             D.PAY_CD,
				              fcBass0300CDNM (D.DPOB_CD, D.PAY_CD)PAY_NM,
				         D.PAY_CD AS payCdcommCd,
				         fcBass0300CDNM (D.DPOB_CD, D.PAY_CD) AS payCdcommCdNm,
				         D.BNK_CD,
				         fcBass0300CDNM (D.DPOB_CD, D.BNK_CD)AS BNK_NM ,
				         D.BNK_CD AS bnkCdcommCd,
				         fcBass0300CDNM (D.DPOB_CD, D.BNK_CD) AS bnkCdcommCdNm,
				         D.BNK_ACCU_NUM,
				         D.ACNT_HODR_NM,
				         D.RPSTTV_ACCU_YN,
				         D.ACCU_NOTE_CTNT
				    FROM PSNL0100 A, PAYR0500 C, PSNL0130 D
					WHERE 1=1
						 AND A.DPOB_CD = C.DPOB_CD
				         AND A.SYSTEMKEY = C.SYSTEMKEY
				         AND A.DPOB_CD = D.DPOB_CD(+)
				         AND A.SYSTEMKEY = D.SYSTEMKEY(+)
				   		<isNotEmpty prepend="AND" property="dpobCd" >
			 				A.DPOB_CD=#dpobCd#
		      			</isNotEmpty>  
				    	<isNotEmpty prepend="AND" property="payrMangDeptCd" >
					 		C.PAYR_MANG_DEPT_CD=#payrMangDeptCd#
				       	</isNotEmpty>  
				       	<isNotEmpty prepend="AND" property="businCd" >
					 		A.BUSIN_CD=#businCd#
				       	</isNotEmpty>  
				       	<isNotEmpty prepend="AND" property="emymtDivCd" >
					 		A.EMYMT_DIV_CD=#emymtDivCd#
				   		</isNotEmpty> 
				        AND EXISTS  (
                                      SELECT  C.DPOB_CD,
                                 C.DTIL_OCCU_INTTN_CD,
                                 C.TYP_OCCU_CD,
                                 C.DEPT_CD FROM 
                                             ( SELECT * 
                                                 FROM TABLE(PKG_DTIL_AUTH.FN_DTIL_AUTH_TB(#dpobCd#,#payrMangDeptYn#,#payrMangDeptCd#,#deptCd#,#usrId#,#deptCdAuth#,'' )) ) C
                                            WHERE     C.DPOB_CD = A.DPOB_CD
						                        AND C.DEPT_CD = A.CURR_AFFN_DEPT_CD
						                        AND NVL(C.TYP_OCCU_CD,'TT')  = NVL(A.TYP_OCCU_CD,'TT') 
                                                AND NVL(C.DTIL_OCCU_INTTN_CD,'TT')  = NVL(A.DTIL_OCCU_INTTN_CD,'TT')
                                               <isNotEmpty property="deptCd" prepend="AND">
												<![CDATA[
												 C.DEPT_CD
												]]>
												<iterate prepend="IN" property="deptCdArr" open="(" close=")" conjunction=",">
												 #deptCdArr[]#
												</iterate>
												</isNotEmpty>  
                                          )  
				       
				           <isNotEmpty property="typOccuCd" prepend="AND">
					<![CDATA[
					 A.TYP_OCCU_CD
					]]>
					<iterate prepend="IN" property="typOccuCdArr" open="(" close=")" conjunction=",">
					 #typOccuCdArr[]#
					</iterate>
					</isNotEmpty>  
					 <isNotEmpty property="dtilOccuInttnCd" prepend="AND">
						<![CDATA[
							 A.DTIL_OCCU_INTTN_CD
						]]>
						<iterate prepend="IN" property="dtilOccuInttnCdArr" open="(" close=")" conjunction=",">
							 #dtilOccuInttnCdArr[]#
						</iterate>
						</isNotEmpty>  
						<isNotEmpty prepend="AND" property="systemkey" >
					 		A.SYSTEMKEY=#systemkey#
				       	</isNotEmpty> 
		ORDER BY A.DPOB_CD ASC,
		         (SELECT LPAD (DEPT_RANK, 5, '0')
		            FROM BASS0400 DD
		           WHERE DD.DEPT_CD = A.CURR_AFFN_DEPT_CD AND DD.DPOB_CD = A.DPOB_CD) ASC,
		         A.RESN_REGN_NUM ASC,
		         A.SYSTEMKEY ASC,
		         D.PAY_CD ASC
		         
	</select>
</sqlMap>